{% load static %}
{% include 'inc/header.html'%}

<style>
/* ... (Todo tu CSS existente, sin cambios) ... */
.top-bar {
    background: var(--white); padding: 20px 25px; border-radius: 8px; margin-bottom: 25px;
    border: 1px solid var(--border-gray); display: flex; justify-content: space-between; align-items: center;
    flex-wrap: wrap; gap: 15px;
}
body.dark-mode .top-bar { background: var(--dark-card); border-color: var(--dark-border); }
.top-bar-left { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
.top-bar h1 { font-size: 1.75rem; color: var(--dark-slate); font-weight: 600; margin: 0; }
body.dark-mode .top-bar h1 { color: var(--dark-text); }
.btn-new {
    padding: 12px 24px; background: var(--steel-blue); color: var(--white);
    border: none; border-radius: 6px; font-weight: 500; cursor: pointer;
    transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px;
    text-decoration: none;
}
.btn-new:hover { background: var(--dark-slate); }
body.dark-mode .btn-new { background: var(--steel-blue-dark); }
body.dark-mode .btn-new:hover { background: var(--steel-blue); }
.search-form { display: flex; gap: 5px; }
.search-input {
    padding: 10px 15px; border: 1px solid var(--border-gray); border-radius: 6px;
    font-size: 0.95rem; background: var(--light-gray); color: var(--dark-slate);
    transition: all 0.2s ease; width: 250px;
}
body.dark-mode .search-input { background: var(--dark-bg-secondary); border-color: var(--dark-border); color: var(--dark-text); }
.search-input:focus { outline: none; border-color: var(--steel-blue); box-shadow: 0 0 0 3px rgba(74, 144, 164, 0.1); }
body.dark-mode .search-input:focus { border-color: var(--steel-blue-dark); box-shadow: 0 0 0 3px rgba(90, 163, 184, 0.2); }
.btn-search {
    padding: 10px 15px; background: var(--ice-blue); color: var(--steel-blue);
    border: 1px solid var(--border-gray); border-radius: 6px; cursor: pointer;
}
body.dark-mode .btn-search { background: var(--dark-bg-secondary); border-color: var(--dark-border); color: var(--steel-blue-dark); }
.reservation-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 25px;
    padding: 0 25px;
}
.reservation-card {
    background: var(--white); border-radius: 8px; border: 1px solid var(--border-gray);
    overflow: hidden; display: flex; flex-direction: column; transition: all 0.3s ease;
    border-left: 5px solid transparent; cursor: pointer;
}
body.dark-mode .reservation-card { background: var(--dark-card); border-color: var(--dark-border); }
.reservation-card:hover { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); transform: translateY(-3px); }
body.dark-mode .reservation-card:hover { box-shadow: 0 4px 15px rgba(255, 255, 255, 0.05); }
.card-pendiente { border-left-color: var(--reserved); }
.card-confirmada { border-left-color: var(--available); }
body.dark-mode .card-pendiente { border-left-color: var(--reserved); }
body.dark-mode .card-confirmada { border-left-color: var(--available); }
.status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; text-transform: uppercase; white-space: nowrap; color: var(--white); }
.status-confirmado { background-color: var(--available); }
.status-pendiente { background-color: var(--reserved); }
.card-header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; background-color: var(--light-gray); border-bottom: 1px solid var(--border-gray); }
body.dark-mode .card-header { background-color: var(--dark-bg-secondary); border-bottom-color: var(--dark-border); }
.reserva-id { font-weight: 600; color: var(--dark-slate); font-size: 0.9rem; }
body.dark-mode .reserva-id { color: var(--dark-text); }
.card-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; gap: 10px; font-size: 0.9rem; color: var(--dark-slate); }
body.dark-mode .card-body { color: var(--dark-text-secondary); }
.card-body > div { display: flex; align-items: center; gap: 8px; }
.card-body i { width: 16px; text-align: center; color: var(--steel-blue); opacity: 0.8; }
body.dark-mode .card-body i { color: var(--steel-blue-dark); }
.card-body .label { font-weight: 500; color: var(--steel-blue); margin-right: 5px; }
body.dark-mode .card-body .label { color: var(--steel-blue-dark); }
.date-item { display: flex; align-items: center; gap: 8px; width: 100%; }
.card-footer { padding: 12px 15px; background-color: var(--light-gray); border-top: 1px solid var(--border-gray); font-size: 0.85rem; color: var(--dark-slate); display: flex; flex-direction: column; gap: 10px; }
body.dark-mode .card-footer { background-color: var(--dark-bg-secondary); border-top-color: var(--dark-border); color: var(--dark-text-secondary); }
.guest-count { display: flex; align-items: center; gap: 8px; }
.btn-confirmar {
    width: 100%; padding: 10px 15px; margin-top: 10px; border: none;
    border-radius: 6px; font-weight: 500; cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease; display: flex;
    align-items: center; justify-content: center; gap: 8px;
}
.btn-confirmar-pendiente { background-color: var(--reserved); color: var(--white); }
.btn-confirmar-pendiente:hover { background-color: #c95151; }
body.dark-mode .btn-confirmar-pendiente { background-color: var(--reserved); }
body.dark-mode .btn-confirmar-pendiente:hover { background-color: var(--reserved); }
.btn-confirmar-confirmado { background-color: var(--light-gray); color: var(--dark-slate); border: 1px solid var(--border-gray); }
.btn-confirmar-confirmado:hover { background-color: var(--ice-blue); }
body.dark-mode .btn-confirmar-confirmado { background-color: var(--dark-bg-secondary); border-color: var(--dark-border); color: var(--dark-text); }
body.dark-mode .btn-confirmar-confirmado:hover { background-color: var(--dark-bg); }
.btn-factura-custom {
    width: 100%; padding: 10px 15px; margin-top: 5px;
    border: 1px solid var(--border-gray); border-radius: 6px; 
    font-weight: 500; cursor: pointer; background-color: var(--steel-blue);
    color: var(--white); transition: all 0.2s ease; display: flex;
    align-items: center; justify-content: center; gap: 8px;
}
.btn-factura-custom:hover { background-color: var(--dark-slate); }
body.dark-mode .btn-factura-custom { background-color: var(--steel-blue-dark); border-color: var(--dark-border); }
body.dark-mode .btn-factura-custom:hover { background-color: var(--steel-blue); }
.modal-content { background-color: var(--white); border: 1px solid var(--border-gray); border-radius: 8px; }
body.dark-mode .modal-content { background-color: var(--dark-card); border-color: var(--dark-border); }
.modal-header { padding: 1rem 1.5rem; background-color: var(--light-gray); border-bottom: 1px solid var(--border-gray); border-top-left-radius: 8px; border-top-right-radius: 8px; }
body.dark-mode .modal-header { background-color: var(--dark-bg-secondary); border-bottom-color: var(--dark-border); }
.modal-title { color: var(--dark-slate); font-weight: 600; }
body.dark-mode .modal-title { color: var(--dark-text); }
.reserva-id-modal { font-weight: bold; color: var(--steel-blue); }
body.dark-mode .reserva-id-modal { color: var(--steel-blue-dark); }
.modal-header .btn-close { background-color: transparent; border: none; opacity: 0.6; }
body.dark-mode .modal-header .btn-close { filter: invert(1) grayscale(100%) brightness(200%); opacity: 0.8; }
.modal-body { padding: 25px; background-color: var(--white); }
body.dark-mode .modal-body { background-color: var(--dark-card); }
.detail-section { margin-bottom: 25px; }
.detail-section:last-child { margin-bottom: 0; }
.detail-section-title { font-size: 1.1rem; font-weight: 600; color: var(--steel-blue); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid var(--ice-blue); display: flex; align-items: center; gap: 10px; }
body.dark-mode .detail-section-title { color: var(--steel-blue-dark); border-bottom-color: var(--dark-border); }
.detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px 20px; }
.detail-item { display: flex; flex-direction: column; gap: 4px; font-size: 0.95rem; }
.detail-item.full-width { grid-column: 1 / -1; }
.detail-label { font-weight: 500; color: var(--steel-blue); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
body.dark-mode .detail-label { color: var(--steel-blue-dark); }
.detail-value { color: var(--dark-slate); word-wrap: break-word; }
body.dark-mode .detail-value { color: var(--dark-text); }
.modal-footer { padding: 1rem 1.5rem; background-color: var(--light-gray); border-top: 1px solid var(--border-gray); border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
body.dark-mode .modal-footer { background-color: var(--dark-bg-secondary); border-top-color: var(--dark-border); }
.btn-danger {
    background-color: var(--occupied); color: var(--white); padding: 10px 20px;
    font-size: 0.9rem; font-weight: 500; border-radius: 6px; border: none;
    cursor: pointer; transition: all 0.2s ease; display: inline-flex;
    align-items: center; gap: 8px; text-decoration: none;
}
.btn-danger:hover { background-color: #c95151; }
.modal-footer { display: flex; justify-content: flex-end; }
.btn-delete-left { margin-right: auto; }

.btn-check-in, .btn-check-out {
    width: 100%;
    padding: 10px 15px;
    margin-top: 5px;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 0.9rem;
}
/* Botón Check-in (Verde) */
.btn-check-in {
    background-color: var(--available, #28a745);
    color: var(--white);
}
.btn-check-in:hover { background-color: #218838; }

/* Botón Check-out (Rojo) */
.btn-check-out {
    background-color: var(--occupied, #dc3545);
    color: var(--white);
}
.btn-check-out:hover { background-color: #c82333; }

/* Estado "Activa" (Estilo para la card) */
.card-activa {
    border-left-color: var(--steel-blue, #4a90a4);
    box-shadow: 0 0 10px rgba(74, 144, 164, 0.3);
}
/* Badge para estado de estancia */
.estancia-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--steel-blue);
    color: white;
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 0.75rem;
    font-weight: 600;
}
.card-header { position: relative; } /* Necesario para el badge */
</style>

<div class="top-bar">
    <div class="top-bar-left">
        <h1><i class="fas fa-calendar-check"></i> Listado de Reservas</h1>
        <form method="GET" action="{% url 'reservas' %}" class="search-form" onsubmit="return false;">
            <input type="text" name="q" id="searchInput" class="search-input" placeholder="Buscar por ID, nombre o estado..." value="{{ request.GET.q|default:'' }}">
            <button type="submit" class="btn-search" style="display: none;"><i class="fas fa-search"></i></button>
        </form>
    </div>
    <div class="top-bar-right">
        <a href="{% url 'reservar' %}" class="btn-new" onclick="window.location.href = '{% url 'reservar' %}'; return false;">
            <i class="fas fa-plus"></i> Nueva Reserva
        </a>    
    </div>
</div>

<div class="reservation-grid">
    
    {% csrf_token %}

    {% for reserva in reservas %}
        <div class="reservation-card 
             {% if reserva.estado_estancia == 'Activa' %}card-activa
             {% elif reserva.confirmado == 'Confirmado' %}card-confirmada
             {% else %}card-pendiente{% endif %}" 
             id="reserva-card-{{ reserva.id }}"
             
             data-bs-toggle="modal" 
             data-bs-target="#reservationModal"
             
             data-id="{{ reserva.id }}"
             data-nombre="{{ reserva.nombre }} {{ reserva.apellido }}"
             data-estado-estancia="{{ reserva.estado_estancia }}" data-identificacion="{{ reserva.identificacion|default:'N/A' }}"
             data-email="{{ reserva.email }}"
             data-telefono-domicilio="{{ reserva.telefono_domicilio|default:'' }}"
             data-telefono-oficina="{{ reserva.telefono_oficina|default:'' }}"
             data-domicilio="{{ reserva.domicilio }}"
             data-ciudad="{{ reserva.ciudad }}"
             data-departamento="{{ reserva.departamento }}"
             data-checkin="{{ reserva.check_in|date:'d M Y, H:i' }}"
             data-checkout="{{ reserva.check_out|date:'d M Y, H:i' }}"
             data-huespedes="{{ reserva.num_hues|default:'1' }}" 
             data-habitaciones="{{ reserva.num_habt|default:'' }}"
             data-hospedaje-deseado="{{ reserva.hospedaje_deseado|default:'' }}"
             data-cotizado="{{ reserva.cotizado|default:'' }}"
             data-solicitado="{{ reserva.solicitado|default:'' }}"
             data-empleado="{{ reserva.empleados|default:'N/A' }}"
             data-telefono-empleado="{{ reserva.telefono|default:'N/A' }}"
             data-confirmado="{{ reserva.confirmado|default:'Pendiente' }}"
             data-forma-pago="{{ reserva.formadepago|default:'N/A' }}"
             data-solicitud="{{ reserva.solicitud|default:'' }}"
             data-observaciones="{{ reserva.observaciones|default:'' }}"
             data-nombre-compania="{{ reserva.nombre_compania|default:'' }}"
             data-domicilio-compania="{{ reserva.compania_domicilio|default:'' }}"
             data-ciudad-compania="{{ reserva.compania_ciudad|default:'' }}"
             data-email-compania="{{ reserva.compania_email|default:'' }}"
             >
            
            <div class="card-header">
                <div>
                    <span class="reserva-id">#{{ reserva.id }}</span>
                    <span class="status-badge 
                        {% if reserva.confirmado == 'Confirmado' %}status-confirmado
                        {% else %}status-pendiente{% endif %}"
                        id="status-badge-{{ reserva.id }}">
                        {{ reserva.confirmado|default:'Pendiente' }}
                    </span>
                </div>
                {% if reserva.estado_estancia != 'Pendiente' %}
                <span class="estancia-badge" id="estancia-badge-{{ reserva.id }}">
                    {{ reserva.get_estado_estancia_display }}
                </span>
                {% endif %}
            </div>
            
            <div class="card-body">
                <div class="guest-name"><i class="fas fa-user"></i><span class="value"><span class="label">Huésped:</span> {{ reserva.nombre }} {{ reserva.apellido }}</span></div>
                <div class="date-item"><i class="fas fa-calendar-day"></i><div><span class="label">Check-in:</span> {{ reserva.check_in|date:"d/m/Y" }}</div></div>
                <div class="date-item"><i class="fas fa-calendar-day"></i><div><span class="label">Check-out:</span> {{ reserva.check_out|date:"d/m/Y" }}</div></div>
                <div class="room-info"><i class="fas fa-door-open"></i><div><span class="label">Tipo:</span> {{ reserva.hospedaje_deseado|default:'N/E' }} ({{ reserva.num_habt|default:'?' }} Hab.)</div></div>
            </div>

            <div class="card-footer">
                <div class="guest-count">
                     <i class="fas fa-users"></i> {{ reserva.num_hues|default:'1' }} Huésped(es)
                </div>
            
                {% if reserva.estado_estancia == 'Pendiente' and reserva.confirmado == 'Confirmado' %}
                <button class="btn-check-in" data-reserva-id="{{ reserva.id }}" id="btn-checkin-{{ reserva.id }}" type="button">
                    <i class="fas fa-sign-in-alt"></i> Realizar Check-in
                </button>
                {% endif %}
                
                {% if reserva.estado_estancia == 'Activa' %}
                <button class="btn-check-out" data-reserva-id="{{ reserva.id }}" id="btn-checkout-{{ reserva.id }}" type="button">
                    <i class="fas fa-sign-out-alt"></i> Realizar Check-out
                </button>
                {% endif %}

                {% if reserva.estado_estancia == 'Pendiente' %}
                <button class="btn-confirmar 
                        {% if reserva.confirmado == 'Confirmado' %}btn-confirmar-confirmado{% else %}btn-confirmar-pendiente{% endif %}"
                        data-reserva-id="{{ reserva.id }}" 
                        id="btn-confirmar-{{ reserva.id }}"
                        type="button"> 
                    {% if reserva.confirmado == 'Confirmado' %}
                        <i class="fas fa-times-circle"></i> Marcar Pendiente
                    {% else %}
                        <i class="fas fa-check-circle"></i> Confirmar Reserva
                    {% endif %}
                </button>
                {% endif %}
                
                {% if reserva.estado_estancia != 'Completada' %}
                <button class="btn-facturar btn-factura-custom" 
                        data-reserva-id="{{ reserva.id }}" 
                        data-facturado="{{ reserva.factura.id|default:'' }}"
                        id="btn-factura-{{ reserva.id }}"
                        type="button"> 
                    {% if reserva.factura %}
                    <i class="fas fa-file-invoice"></i> Ver Factura #{{ reserva.factura.id }}
                    {% else %}
                    <i class="fas fa-calculator"></i> Generar Factura
                    {% endif %}
                </button>
                {% endif %}
                
                </div>
            
        </div> {% empty %}
        <p style="grid-column: 1 / -1; text-align: center; padding: 50px;">No hay reservas para mostrar. Puedes crear una <a href="{% url 'reservar' %}">aquí</a>.</p> 
    {% endfor %}

</div>

<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reservationModalLabel">Detalles Reserva <span class="reserva-id-modal" id="modalReservaId">#</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBodyContent"><p>Cargando detalles...</p></div>
            <div class="modal-footer">
                <a href="#" id="btn-delete-reserva" class="btn-danger btn-delete-left"><i class="fas fa-trash"></i> Eliminar</a>
                <a href="#" id="btn-edit-reserva" class="btn btn-primary" style="background-color: var(--reserved);"><i class="fas fa-edit"></i> Editar Reserva</a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    let currentReservaIdForModal = null;
    function getCookie(name) { /* ... (Función getCookie) ... */
        let cookieValue = null; if (document.cookie && document.cookie !== '') { const cookies = document.cookie.split(';'); for (let i = 0; i < cookies.length; i++) { const cookie = cookies[i].trim(); if (cookie.substring(0, name.length + 1) === (name + '=')) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; } } } return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    const createDetailItem = (label, value, isFullWidth = false) => { /* ... (Función createDetailItem) ... */
        const displayValue = value || 'N/A'; const fullWidthClass = isFullWidth ? 'full-width' : ''; return `
        <div class="detail-item ${fullWidthClass}"><span class="detail-label">${label}</span><span class="detail-value">${displayValue}</span></div>`;
    };

    // --- Variables del Modal y Botones ---
    const btnEditReserva = document.getElementById('btn-edit-reserva');
    const btnDeleteReserva = document.getElementById('btn-delete-reserva');
    const editUrlTemplate = "{% url 'editarreserva' 0 %}"; 
    const deleteUrlTemplate = "{% url 'eliminarreserva' 0 %}";
    const viewFacturaUrlTemplate = "{% url 'verfactura' 0 %}";
    const modalElement = document.getElementById('reservationModal');
    
    // --- ¡NUEVAS URLS! ---
    const checkInUrlTemplate = "{% url 'realizarcheckin' 0 %}";
    const checkOutUrlTemplate = "{% url 'realizarcheckout' 0 %}";

    // --- Función 1: Generación de HTML del Modal ---
    function generateModalHTML(reservaData) { /* ... (Tu función generateModalHTML completa) ... */ 
        const mostrarCompania = reservaData.nombreCompania && reservaData.nombreCompania.trim() !== '';
        let companySectionHTML = '';
        if (mostrarCompania) { companySectionHTML = `<div class="detail-section"><div class="detail-section-title"><i class="fas fa-building"></i> Datos de Compañía</div><div class="detail-grid">${createDetailItem('Nombre Compañía', reservaData.nombreCompania)}${createDetailItem('Email Compañía', reservaData.emailCompania)}<div class="detail-item full-width"><span class="detail-label">Domicilio Compañía</span><span class="detail-value">${reservaData.domicilioCompania || 'N/A'}, ${reservaData.ciudadCompania || ''}</span></div></div></div>`; }
        return `
            <div class="detail-section"><div class="detail-section-title"><i class="fas fa-user"></i> Datos del Huésped</div><div class="detail-grid">${createDetailItem('Nombre Completo', reservaData.nombre)}${createDetailItem('Identificación', reservaData.identificacion)}${createDetailItem('Email', reservaData.email)}${createDetailItem('Tel. Domicilio', reservaData.telefonoDomicilio)}${createDetailItem('Tel. Oficina', reservaData.telefonoOficina)}<div class="detail-item full-width"><span class="detail-label">Domicilio</span><span class="detail-value">${reservaData.domicilio || 'N/A'}, ${reservaData.ciudad || ''}, ${reservaData.departamento || ''}</span></div></div></div>
            <div class="detail-section"><div class="detail-section-title"><i class="fas fa-calendar-alt"></i> Detalles de la Estancia</div><div class="detail-grid">${createDetailItem('Check-in', reservaData.checkin)}${createDetailItem('Check-out', reservaData.checkout)}${createDetailItem('Nº Huéspedes', reservaData.huespedes)}${createDetailItem('Nº Habitaciones', reservaData.habitaciones)}${createDetailItem('Hospedaje Deseado', reservaData.hospedajeDeseado)}<div class="detail-item"><span class="detail-label">Estado</span><span class="detail-value">${reservaData.confirmado || 'N/A'}</span></div></div></div>
            ${companySectionHTML} <div class="detail-section mb-0"><div class="detail-section-title"><i class="fas fa-clipboard-list"></i> Notas y Pagos</div><div class="detail-grid">${createDetailItem('Forma de Pago', reservaData.formaPago)}${createDetailItem('Tarifa Cotizada', '$ ' + (reservaData.cotizado || 'N/A'))}${createDetailItem('Depósito Solicitado', '$ ' + (reservaData.solicitado || 'N/A'))}${createDetailItem('Solicitudes Especiales', reservaData.solicitud, true)}${createDetailItem('Observaciones', reservaData.observaciones, true)}${createDetailItem('Reserva Hecha por', `${reservaData.empleado || 'N/A'} (Tel: ${reservaData.telefonoEmpleado || 'N/A'})`)}</div></div>`;
    }

    // --- Función 2: Lógica Principal del Modal ---
    if (modalElement) {
        modalElement.addEventListener('show.bs.modal', function (event) {
            const card = event.relatedTarget;
            // ¡IMPORTANTE! Actualizado para incluir los nuevos botones
            if (event.relatedTarget && event.relatedTarget.closest('.btn-confirmar, .btn-facturar, .btn-check-in, .btn-check-out')) {
                event.preventDefault(); 
                return;
            }
            if (!card || !card.classList.contains('reservation-card')) return;
            // ... (resto de la lógica: rellenar modal, actualizar href) ...
            const reservaData = card.dataset;
            const modalTitleId = modalElement.querySelector('#modalReservaId');
            const modalBody = modalElement.querySelector('#modalBodyContent');
            modalTitleId.textContent = `#${reservaData.id || 'N/A'}`; 
            modalBody.innerHTML = generateModalHTML(reservaData); 
            currentReservaIdForModal = reservaData.id; 
            if(btnEditReserva) { btnEditReserva.href = editUrlTemplate.replace('0', currentReservaIdForModal); }
        });
        modalElement.addEventListener('hidden.bs.modal', function (event) { currentReservaIdForModal = null; });
    }

    // --- Función 3: Lógica de Botones (Confirmar, Facturar, Check-in, Check-out) ---
    const gridContainer = document.querySelector('.reservation-grid');
    if (gridContainer) {
        gridContainer.addEventListener('click', function(event) {
            
            // --- Lógica de Confirmar ---
            const confirmButton = event.target.closest('.btn-confirmar');
            if (confirmButton) {
                event.stopPropagation();
                // ... (Tu lógica AJAX de ConfirmarReserva, sin cambios) ...
                const reservaId = confirmButton.dataset.reservaId; const url = `/reservas/confirmar/${reservaId}/`;
                confirmButton.disabled = true; confirmButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }})
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        // ... (lógica de actualizar la card) ...
                        window.location.reload(); // Recargar la página para mostrar el botón de Check-in
                    } else { alert(`Error al actualizar: ${data.message}`); }
                })
                .catch(error => { alert('Error de red al confirmar.'); })
                .finally(() => { /* ... (restaurar botón) ... */ });
                return;
            }

            // --- Lógica de Facturar ---
            const factButton = event.target.closest('.btn-facturar');
            if (factButton) {
                event.stopPropagation();
                // ... (Tu lógica AJAX de GenerarFactura / VerFactura, sin cambios) ...
                const reservaId = factButton.dataset.reservaId; const yaFacturado = factButton.dataset.facturado;
                if (yaFacturado) { window.location.href = viewFacturaUrlTemplate.replace('0', yaFacturado); return; }
                const url = `/facturas/generar/${reservaId}/`; 
                factButton.disabled = true; factButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando...';
                fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }})
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        factButton.dataset.facturado = data.factura_id;
                        factButton.style.backgroundColor = 'var(--dark-slate)';
                        factButton.innerHTML = `<i class="fas fa-file-invoice"></i> Ver Factura #${data.factura_id}`;
                        const urlFactura = viewFacturaUrlTemplate.replace('0', data.factura_id);
                        window.open(urlFactura, '_blank');
                    } else { alert(`Fallo en la Facturación: ${data.message}`); factButton.innerHTML = '<i class="fas fa-calculator"></i> Generar Factura'; }
                })
                .catch(error => { alert(`Error de conexión o validación: ${error.message}`); factButton.innerHTML = '<i class="fas fa-calculator"></i> Generar Factura'; })
                .finally(() => { factButton.disabled = false; });
                return;
            }

            // --- ¡NUEVA LÓGICA DE CHECK-IN! ---
            const checkInButton = event.target.closest('.btn-check-in');
            if (checkInButton) {
                event.stopPropagation();
                const reservaId = checkInButton.dataset.reservaId;
                const url = checkInUrlTemplate.replace('0', reservaId);

                if (!confirm(`¿Confirmar Check-in para la Reserva #${reservaId}? Esto marcará las habitaciones como 'Ocupadas'.`)) return;

                checkInButton.disabled = true;
                checkInButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        alert(data.message);
                        window.location.reload(); // Recargar para actualizar el estado y los botones
                    } else {
                        alert(`Error en Check-in: ${data.message}`);
                        checkInButton.disabled = false;
                        checkInButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Realizar Check-in';
                    }
                })
                .catch(error => {
                    alert(`Error de red: ${error.message}`);
                    checkInButton.disabled = false;
                    checkInButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Realizar Check-in';
                });
                return;
            }
            
            // --- ¡NUEVA LÓGICA DE CHECK-OUT! ---
            const checkOutButton = event.target.closest('.btn-check-out');
            if (checkOutButton) {
                event.stopPropagation();
                const reservaId = checkOutButton.dataset.reservaId;
                const url = checkOutUrlTemplate.replace('0', reservaId);

                if (!confirm(`¿Confirmar Check-out para la Reserva #${reservaId}? Esto SOLO funcionará si la factura ya está pagada y marcará las habitaciones como 'Limpieza'.`)) return;

                checkOutButton.disabled = true;
                checkOutButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        alert(data.message);
                        window.location.reload(); // Recargar para ocultar la card o actualizarla
                    } else {
                        alert(`Error en Check-out: ${data.message}`);
                        checkOutButton.disabled = false;
                        checkOutButton.innerHTML = '<i class="fas fa-sign-out-alt"></i> Realizar Check-out';
                    }
                })
                .catch(error => {
                    alert(`Error de red: ${error.message}`);
                    checkOutButton.disabled = false;
                    checkOutButton.innerHTML = '<i class="fas fa-sign-out-alt"></i> Realizar Check-out';
                });
                return;
            }
            
        });
    }

    // --- Lógica del Botón Eliminar (sin cambios) ---
    if (btnDeleteReserva) {
        btnDeleteReserva.addEventListener('click', function(event) {
            // ... (Tu lógica AJAX de EliminarReserva, sin cambios) ...
            event.preventDefault(); 
            if (!currentReservaIdForModal) { alert('Error: No se pudo encontrar el ID de la reserva.'); return; }
            if (!confirm(`¿Estás seguro de que deseas eliminar la Reserva #${currentReservaIdForModal}? Esta acción no se puede deshacer y desasignará las habitaciones.`)) { return; }
            const reservaId = currentReservaIdForModal;
            const url = deleteUrlTemplate.replace('0', reservaId);
            btnDeleteReserva.disabled = true;
            btnDeleteReserva.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';
            fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }})
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    modalInstance.hide();
                    const cardToRemove = document.getElementById(`reserva-card-${reservaId}`);
                    if (cardToRemove) { cardToRemove.remove(); } // Eliminación más rápida
                    alert(data.message);
                } else { alert(`Error al eliminar: ${data.message}`); }
            })
            .catch(error => { alert(`Error de red: ${error.message}`); })
            .finally(() => {
                btnDeleteReserva.disabled = false;
                btnDeleteReserva.innerHTML = '<i class="fas fa-trash"></i> Eliminar';
            });
        });
    }

    // --- Lógica del Buscador (sin cambios) ---
    const searchInput = document.getElementById('searchInput');
    const allCards = document.querySelectorAll('.reservation-card');
    if (searchInput && allCards.length > 0) {
        searchInput.addEventListener('input', function() {
            // ... (Tu lógica de búsqueda/filtrado, sin cambios) ...
            const searchTerm = searchInput.value.toLowerCase().trim(); 
            allCards.forEach(card => {
                const reservaId = card.dataset.id || '';
                const nombreCompleto = card.dataset.nombre ? card.dataset.nombre.toLowerCase() : '';
                const estado = card.dataset.confirmado ? card.dataset.confirmado.toLowerCase() : '';
                const cardText = `${reservaId} ${nombreCompleto} ${estado}`;
                if (cardText.includes(searchTerm)) { card.style.display = ''; } else { card.style.display = 'none'; }
            });
        });
    }

}); // <-- FIN DEL DOMContentLoaded
</script>

{% include 'inc/footer.html'%}