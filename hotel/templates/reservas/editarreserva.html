{% load static %}
{% include 'inc/header.html'%}

<style xmlns="http://www.w3.org/1999/html">
    /* === COPIA Y PEGA AQUÍ TODO EL CONTENIDO DE LA ETIQUETA <style> DE TU ARCHIVO RESERVAR.HTML === */
    /* Page Header */
    .page-header {
        background: var(--white);
        padding: 25px;
        border-radius: 8px;
        margin-bottom: 25px;
        border: 1px solid var(--border-gray);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    body.dark-mode .page-header {
        background: var(--dark-card);
        border-color: var(--dark-border);
    }

    .page-header h1 {
        font-size: 1.75rem;
        color: var(--dark-slate);
        font-weight: 600;
        margin: 0;
    }

    body.dark-mode .page-header h1 {
        color: var(--dark-text);
    }

    .btn-back {
        padding: 10px 20px;
        background: var(--light-gray);
        border: 1px solid var(--border-gray);
        border-radius: 6px;
        color: var(--dark-slate);
        text-decoration: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-back:hover {
        background: var(--ice-blue);
        border-color: var(--steel-blue);
    }

    body.dark-mode .btn-back {
        background: var(--dark-bg-secondary);
        border-color: var(--dark-border);
        color: var(--dark-text);
    }

    body.dark-mode .btn-back:hover {
        background: var(--dark-bg);
        border-color: var(--steel-blue-dark);
    }

    /* Form Container */
    .form-container {
        background: var(--white);
        padding: 30px;
        border-radius: 8px;
        border: 1px solid var(--border-gray);
        max-width: 1000px;
        margin: 0 auto;
    }

    body.dark-mode .form-container {
        background: var(--dark-card);
        border-color: var(--dark-border);
    }

    .form-section {
        margin-bottom: 35px;
    }

    .form-section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--steel-blue);
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--ice-blue);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    body.dark-mode .form-section-title {
        color: var(--steel-blue-dark);
        border-bottom-color: var(--dark-border);
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-row-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    .form-label {
        display: block;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--dark-slate);
        margin-bottom: 8px;
    }

    body.dark-mode .form-label {
        color: var(--dark-text);
    }

    .form-label .required {
        color: var(--occupied);
    }

    .form-input,
    .form-select,
    .form-textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--border-gray);
        border-radius: 6px;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        font-family: inherit;
        background: var(--white);
        color: var(--dark-slate);
    }

    body.dark-mode .form-input,
    body.dark-mode .form-select,
    body.dark-mode .form-textarea {
        background: var(--dark-bg-secondary);
        border-color: var(--dark-border);
        color: var(--dark-text);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
        outline: none;
        border-color: var(--steel-blue);
        box-shadow: 0 0 0 3px rgba(74, 144, 164, 0.1);
    }

    body.dark-mode .form-input:focus,
    body.dark-mode .form-select:focus,
    body.dark-mode .form-textarea:focus {
        border-color: var(--steel-blue-dark);
        box-shadow: 0 0 0 3px rgba(90, 163, 184, 0.2);
    }

    .form-textarea {
        resize: vertical;
        min-height: 100px;
    }

    /* Info Box */
    .info-box {
        background: var(--ice-blue);
        border-left: 4px solid var(--steel-blue);
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }

    body.dark-mode .info-box {
        background: var(--dark-bg-secondary);
        border-left-color: var(--steel-blue-dark);
    }

    .info-box p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--dark-slate);
    }

    body.dark-mode .info-box p {
        color: var(--dark-text);
    }
    
    /* Error Feedback */
    .invalid-feedback {
        color: var(--occupied); /* Usar el color rojo */
        font-size: 0.85em;
        margin-top: 4px;
    }
    .d-block { display: block !important; }

    /* Buttons */
    .form-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--border-gray);
    }

    body.dark-mode .form-actions {
        border-top-color: var(--dark-border);
    }

    .btn {
        padding: 12px 30px;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }

    .btn-primary {
        background: var(--steel-blue);
        color: var(--white);
    }

    .btn-primary:hover {
        background: var(--dark-slate);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(74, 144, 164, 0.3);
    }

    body.dark-mode .btn-primary {
        background: var(--steel-blue-dark);
    }

    body.dark-mode .btn-primary:hover {
        background: var(--steel-blue);
    }

    .btn-secondary {
        background: var(--light-gray);
        color: var(--dark-slate);
        border: 1px solid var(--border-gray);
    }

    .btn-secondary:hover {
        background: var(--ice-blue);
    }

    body.dark-mode .btn-secondary {
        background: var(--dark-bg-secondary);
        border-color: var(--dark-border);
        color: var(--dark-text);
    }

    body.dark-mode .btn-secondary:hover {
        background: var(--dark-bg);
    }
    
    .btn-info { /* Estilo para el botón de perfil de huésped */
        background: var(--ice-blue);
        color: var(--steel-blue);
        border: 1px solid var(--steel-blue);
        padding: 8px 15px;
        font-size: 0.9rem;
        font-weight: 500;
    }
    .btn-info:hover {
        background: var(--steel-blue);
        color: var(--white);
    }
    
    body.dark-mode .btn-info {
        background: var(--dark-bg-secondary);
        color: var(--steel-blue-dark);
        border-color: var(--steel-blue-dark);
    }
    body.dark-mode .btn-info:hover {
        background: var(--steel-blue-dark);
        color: var(--white);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .form-container {
            padding: 20px;
        }

        .form-row,
        .form-row-3 {
            grid-template-columns: 1fr;
        }

        .page-header {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }

        .form-actions {
            flex-direction: column;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }

        .payment-options {
            flex-direction: column;
            gap: 15px;
        }
    }
    /* === FIN DEL CONTENIDO DE LA ETIQUETA <style> DE RESERVAR.HTML === */
</style>

<div class="page-header">
    <h1><i class="fas fa-edit"></i> Editando Reserva #{{ reserva.id }}</h1>
    <a href="{% url 'reservas' %}" class="btn-back">
        <i class="fas fa-arrow-left"></i> Volver
    </a>
</div>

<div class="form-container">
    <form method="POST" action="">
        {% csrf_token %}

        {% if messages %}
             <div style="margin-bottom: 20px;">
                {% for message in messages %}
                    <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        {% if form.non_field_errors %}
             <div class="alert alert-danger" role="alert">
                {% for error in form.non_field_errors %} <p style="margin: 0;">{{ error }}</p> {% endfor %}
            </div>
        {% endif %}

        
        <div class="form-section">
            <h2 class="form-section-title">
                <i class="fas fa-user"></i> Huésped Titular y Facturación
            </h2>
            
            <div class="form-group">
                <label for="{{ form.huesped_principal.id_for_label }}" class="form-label">
                    {{ form.huesped_principal.label }}
                </label>
                {{ form.huesped_principal }}
                {% for error in form.huesped_principal.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
            </div>

            <div id="huesped-link-container" style="display: none; margin-bottom: 20px;">
                </div>


            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Apellidos <span class="required">*</span></label>
                    {{ form.apellido }}
                    {% for error in form.apellido.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>
                <div class="form-group">
                    <label class="form-label">Nombres <span class="required">*</span></label>
                    {{ form.nombre }}
                    {% for error in form.nombre.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Cédula/NIT <span class="required">*</span></label>
                    {{ form.identificacion }}
                    {% for error in form.identificacion.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>
                <div class="form-group">
                    <label class="form-label">E-mail <span class="required">*</span></label>
                    {{ form.email }}
                    {% for error in form.email.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>
            </div>

            <div class="form-group full-width">
                <label class="form-label">Domicilio <span class="required">*</span></label>
                {{ form.domicilio }}
                {% for error in form.domicilio.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
            </div>

            <div class="form-row-3">
                <div class="form-group">
                    <label class="form-label">Ciudad <span class="required">*</span></label>
                    {{ form.ciudad }}
                    {% for error in form.ciudad.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>
                <div class="form-group">
                    <label class="form-label">Departamento <span class="required">*</span></label>
                    {{ form.departamento }}
                    {% for error in form.departamento.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>
                <div class="form-group">
                    <label class="form-label">Teléfono Domicilio <span class="required">*</span></label>
                    {{ form.telefono_domicilio }}
                    {% for error in form.telefono_domicilio.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Teléfono Oficina</label>
                    {{ form.telefono_oficina }}
                </div>
            </div>
        </div>

        <div class="form-section">
            <h2 class="form-section-title">
                <i class="fas fa-calendar-alt"></i> Fechas y Detalles de la Reserva
            </h2>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">
                        Fecha de Llegada <span class="required">*</span>
                    </label>
                    {{ form.check_in }}
                    {% for error in form.check_in.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>

                <div class="form-group">
                    <label class="form-label">
                        Fecha de Salida <span class="required">*</span>
                    </label>
                    {{ form.check_out }}
                    {% for error in form.check_out.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">
                        N° de Huéspedes <span class="required">*</span>
                    </label>
                    {{ form.num_hues }}
                    {% for error in form.num_hues.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>

                <div class="form-group">
                    <label class="form-label">
                        N° de Habitaciones <span class="required">*</span>
                    </label>
                    {{ form.num_habt }}
                    {% for error in form.num_habt.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">
                        N° de Acompañantes
                    </label>
                    {{ form.companion }}
                    {% for error in form.companion.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>

                <div class="form-group">
                    <label class="form-label">
                        Hospedaje Deseado
                    </label>
                    {{ form.hospedaje_deseado }}
                    {% for error in form.hospedaje_deseado.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">
                        Tarifa Cotizada
                    </label>
                    {{ form.cotizado }}
                    {% for error in form.cotizado.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>

                <div class="form-group">
                    <label class="form-label">
                        Depósito Solicitado
                    </label>
                    {{ form.solicitado }}
                    {% for error in form.solicitado.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>
            </div>
        </div>

        <div class="form-section">
            <h2 class="form-section-title">
                <i class="fas fa-credit-card"></i> Forma de Pago
            </h2>

            <div class="form-group">
                <label class="form-label">
                    Forma de Pago <span class="required">*</span>
                </label>
                {{ form.formadepago }}
                {% for error in form.formadepago.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
            </div>
        </div>

        <div class="form-section" id="company-section" style="display: none;">
            <h2 class="form-section-title">
                <i class="fas fa-building"></i> Información de la Compañía
            </h2>

            <div class="info-box">
                <p><i class="fas fa-info-circle"></i> Complete esta sección solo si la compañía pagará la reserva.</p>
            </div>

            <div class="form-group">
                <label class="form-label">
                    Nombre de la Compañía
                </label>
                {{ form.nombre_compania }}
                {% for error in form.nombre_compania.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
            </div>

            <div class="form-group">
                <label class="form-label">
                    Domicilio de la Compañía
                </label>
                {{ form.compania_domicilio }}
                {% for error in form.compania_domicilio.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">
                        Ciudad
                    </label>
                    {{ form.compania_ciudad }}
                    {% for error in form.compania_ciudad.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>

                <div class="form-group">
                    <label class="form-label">
                        E-mail Compañía
                    </label>
                    {{ form.compania_email }}
                    {% for error in form.compania_email.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>
            </div>
        </div>

        <div class="form-section">
            <h2 class="form-section-title">
                <i class="fas fa-clipboard-list"></i> Información Adicional
            </h2>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">
                        Registrado por (Empleado) <span class="required">*</span>
                    </label>
                    {{ form.empleados }}
                    {% for error in form.empleados.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>

                <div class="form-group">
                    <label class="form-label">
                        Teléfono de Contacto <span class="required">*</span>
                    </label>
                    {{ form.telefono }}
                    {% for error in form.telefono.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">
                    Solicitudes Especiales
                </label>
                {{ form.solicitud }}
            </div>

            <div class="form-group">
                <label class="form-label">
                    Observaciones Especiales
                </label>
                {{ form.observaciones }}
            </div>
        </div>
        <div class="form-actions">
            <a href="{% url 'reservas' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Guardar Cambios
            </button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- Elementos para el Huésped Titular ---
        const huespedSelect = document.getElementById('id_huesped_principal'); // El select del huésped
        const linkContainer = document.getElementById('huesped-link-container');
        
        // --- Elementos a autocompletar (IDs estándar de Django) ---
        const fieldsToUpdate = {
            'nombre': document.getElementById('id_nombre'),
            'apellido': document.getElementById('id_apellido'),
            'identificacion': document.getElementById('id_identificacion'),
            'email': document.getElementById('id_email'),
            'domicilio': document.getElementById('id_domicilio'), 
            'telefono_domicilio': document.getElementById('id_telefono_domicilio'),
        };

        // URL Templates para el JS (usando las URL names de Django)
        const editUrlTemplate = "{% url 'editarhuesped' 0 %}";
        const ajaxUrlTemplate = "{% url 'huespeddetallesajax' 0 %}";

        // --- Función 1: Manejar el cambio en el desplegable de Huésped ---
        async function handleHuespedSelect(event) {
            const huespedId = event.target.value;
            
            if (!huespedId || huespedId === '') {
                // Limpiar campos y ocultar el enlace
                // NO limpiamos los campos aquí en la edición, ya que pueden contener data guardada
                // del último huésped o de la reserva si no se usó huesped_principal.
                linkContainer.style.display = 'none';
                linkContainer.innerHTML = '';
                return;
            }

            const urlDetalles = ajaxUrlTemplate.replace('0', huespedId);

            try {
                const response = await fetch(urlDetalles);
                const data = await response.json();

                if (data.status === 'ok') {
                    // a) Autocompletar los campos del formulario
                    // Sobreescribe los campos de facturación con los datos del Huésped Registrado
                    for (const key in fieldsToUpdate) {
                        if (fieldsToUpdate[key] && data[key] !== undefined) {
                            fieldsToUpdate[key].value = data[key] || ''; 
                        }
                    }

                    // b) Crear y mostrar el enlace de perfil
                    const link = document.createElement('a');
                    link.className = 'btn btn-info'; 
                    link.style.display = 'block';
                    link.style.width = 'fit-content';
                    
                    link.href = editUrlTemplate.replace('0', huespedId);
                    link.target = '_blank'; 
                    link.innerHTML = `<i class="fas fa-user-edit"></i> Ver/Editar perfil completo`;
                    
                    linkContainer.innerHTML = '';
                    linkContainer.appendChild(link);
                    linkContainer.style.display = 'block';
                    
                } else {
                    console.error("Error al cargar detalles del huésped:", data.message);
                    alert("Error: No se pudo cargar la información del huésped.");
                }

            } catch (error) {
                console.error("Error en la petición AJAX:", error);
                alert("Error de red: No se pudo contactar al servidor.");
            }
        }

        // --- Asignar el Event Listener para Huésped ---
        if (huespedSelect) {
            huespedSelect.addEventListener('change', handleHuespedSelect);
             // Ejecutar al inicio si hay un valor pre-cargado (común en edición)
            if (huespedSelect.value) {
                // Usamos setTimeout para asegurar que todos los campos del form estén precargados por Django primero
                setTimeout(() => {
                    handleHuespedSelect({ target: huespedSelect }); 
                }, 50); // Pequeña espera
            }
        }


        // --- Función 2: Lógica de la forma de pago (Compañía) ---
        const companySection = document.getElementById('company-section');
        // Usamos el ID estándar que genera Django
        const formaPagoElement = document.getElementById('id_formadepago'); 

        function toggleCompanyFields() {
            if (formaPagoElement && companySection) {
                // Asumo que 'cobrar_compania' es el valor de la opción para la compañía
                if (formaPagoElement.value === 'cobrar_compania') {
                    companySection.style.display = 'block';
                } else {
                    companySection.style.display = 'none';
                }
            }
        }
        
        if (formaPagoElement) {
            formaPagoElement.addEventListener('change', toggleCompanyFields);
            toggleCompanyFields(); // Ejecutar al cargar la página para reflejar el valor inicial
        }
        
    });
</script>

{% include 'inc/footer.html'%}