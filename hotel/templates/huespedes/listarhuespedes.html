{% load static %}
{% include 'inc/header.html'%}

<style>
    /* === ESTILOS GENERALES === */
    /* ... (tus estilos .page-header, .btn-new, .btn-back) ... */
    .page-header {
        background: var(--white); padding: 25px; border-radius: 8px; margin-bottom: 25px;
        border: 1px solid var(--border-gray); display: flex; justify-content: space-between; align-items: center;
    }
    body.dark-mode .page-header { background: var(--dark-card); border-color: var(--dark-border); }
    .page-header h1 { font-size: 1.75rem; color: var(--dark-slate); font-weight: 600; margin: 0; }
    body.dark-mode .page-header h1 { color: var(--dark-text); }
    .btn-new, .btn-back {
        padding: 10px 20px; background: var(--steel-blue); color: var(--white);
        border: none; border-radius: 6px; font-weight: 500; cursor: pointer;
        transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px;
        text-decoration: none;
    }
    .btn-new:hover { background: var(--dark-slate); }
    body.dark-mode .btn-new { background: var(--steel-blue-dark); }
    body.dark-mode .btn-new:hover { background: var(--steel-blue); }
    .btn-back { background: var(--light-gray); color: var(--dark-slate); border: 1px solid var(--border-gray); }
    body.dark-mode .btn-back { background: var(--dark-bg-secondary); border-color: var(--dark-border); color: var(--dark-text); }

    /* === ESTILOS HUESPED GRID & CARD === */
    /* ... (tus estilos .huesped-grid, .huesped-card, .card-header, etc.) ... */
    .huesped-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }
    .huesped-card {
        background: var(--white); border-radius: 8px; border: 1px solid var(--border-gray);
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column;
        transition: all 0.3s ease; cursor: pointer;
    }
    body.dark-mode .huesped-card { background: var(--dark-card); border-color: var(--dark-border); }
    .huesped-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
    body.dark-mode .huesped-card:hover { box-shadow: 0 5px 15px rgba(255, 255, 255, 0.05); }
    .card-header { padding: 15px 20px; border-bottom: 1px solid var(--border-gray); display: flex; align-items: center; gap: 15px; }
    body.dark-mode .card-header { border-bottom-color: var(--dark-border); }
    .huesped-avatar {
        width: 45px; height: 45px; border-radius: 50%; background: var(--steel-blue);
        color: var(--white); display: inline-flex; align-items: center; justify-content: center;
        font-size: 1.5rem; font-weight: 600; flex-shrink: 0;
    }
    body.dark-mode .huesped-avatar { background: var(--steel-blue-dark); }
    .huesped-info { flex-grow: 1; overflow: hidden; }
    .huesped-nombre {
        font-size: 1.1rem; font-weight: 600; color: var(--dark-slate);
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    body.dark-mode .huesped-nombre { color: var(--dark-text); }
    .huesped-id { font-size: 0.85rem; color: var(--medium-gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    body.dark-mode .huesped-id { color: var(--dark-text-secondary); }
    .card-body { padding: 20px; font-size: 0.9rem; color: var(--dark-slate); display: flex; flex-direction: column; gap: 12px; }
    body.dark-mode .card-body { color: var(--dark-text-secondary); }
    .info-item { display: flex; align-items: center; gap: 10px; }
    .info-item i { width: 16px; text-align: center; color: var(--steel-blue); opacity: 0.8; }
    body.dark-mode .info-item i { color: var(--steel-blue-dark); }
    
    /* === ESTILOS DEL MODAL === */
    /* ... (tus estilos .modal-content, .modal-header, .detail-section, etc.) ... */
    .modal-content { background-color: var(--white); border: 1px solid var(--border-gray); border-radius: 8px; }
    body.dark-mode .modal-content { background-color: var(--dark-card); border-color: var(--dark-border); color: var(--dark-text); }
    .modal-header { padding: 1rem 1.5rem; background-color: var(--light-gray); border-bottom: 1px solid var(--border-gray); }
    body.dark-mode .modal-header { background-color: var(--dark-bg-secondary); border-bottom-color: var(--dark-border); }
    .modal-title { color: var(--dark-slate); font-weight: 600; }
    body.dark-mode .modal-title { color: var(--dark-text); }
    .modal-header .btn-close { filter: none; opacity: 0.6; }
    body.dark-mode .modal-header .btn-close { filter: invert(1) grayscale(100%) brightness(200%); opacity: 0.8; }
    .modal-body { padding: 25px; }
    body.dark-mode .modal-body { background-color: var(--dark-card); }
    .detail-section { margin-bottom: 25px; }
    .detail-section:last-child { margin-bottom: 0; }
    .detail-section-title { font-size: 1.1rem; font-weight: 600; color: var(--steel-blue); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid var(--ice-blue); display: flex; align-items: center; gap: 10px; }
    body.dark-mode .detail-section-title { color: var(--steel-blue-dark); border-bottom-color: var(--dark-border); }
    .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px 20px; }
    .detail-item { display: flex; flex-direction: column; gap: 4px; font-size: 0.95rem; }
    .detail-item.full-width { grid-column: 1 / -1; }
    .detail-label { font-weight: 500; color: var(--steel-blue); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
    body.dark-mode .detail-label { color: var(--steel-blue-dark); }
    .detail-value { color: var(--dark-slate); word-wrap: break-word; }
    body.dark-mode .detail-value { color: var(--dark-text); }
    .modal-footer { padding: 1rem 1.5rem; background-color: var(--light-gray); border-top: 1px solid var(--border-gray); }
    body.dark-mode .modal-footer { background-color: var(--dark-bg-secondary); border-top-color: var(--dark-border); }
    .btn { padding: 10px 25px; border-radius: 6px; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; border: none; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
    .btn-primary { background: var(--steel-blue); color: var(--white); }
    .btn-primary:hover { background: var(--dark-slate); }
    body.dark-mode .btn-primary { background: var(--steel-blue-dark); }
    body.dark-mode .btn-primary:hover { background: var(--steel-blue); }
    .btn-secondary { background: var(--light-gray); color: var(--dark-slate); border: 1px solid var(--border-gray); }
    .btn-secondary:hover { background: var(--ice-blue); }
    body.dark-mode .btn-secondary { background: var(--dark-bg-secondary); border-color: var(--dark-border); color: var(--dark-text); }
    body.dark-mode .btn-secondary:hover { background: var(--dark-bg); }
    .btn-danger { background: #DC3545; color: var(--white); border: 1px solid #DC3545; }
    .btn-danger:hover { background: #c82333; }
    body.dark-mode .btn-danger { background: #E74C3C; border-color: #E74C3C; }
    body.dark-mode .btn-danger:hover { background: #c0392b; }

    /* --- ¡NUEVOS ESTILOS PARA MINI-CARD DE RESERVA! --- */
    #huesped-reservas-container {
        max-height: 200px; /* Límite de altura */
        overflow-y: auto; /* Scroll si hay muchas reservas */
        padding-right: 10px; /* Espacio para el scrollbar */
    }
    .reserva-mini-card {
        background: var(--light-gray);
        border: 1px solid var(--border-gray);
        border-radius: 6px;
        padding: 10px 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 15px;
    }
    body.dark-mode .reserva-mini-card {
        background: var(--dark-bg-secondary);
        border-color: var(--dark-border);
    }
    .reserva-mini-card-info {
        font-size: 0.9rem;
    }
    .reserva-mini-card-info .reserva-id {
        font-weight: 600;
        color: var(--dark-slate);
        display: block;
    }
    body.dark-mode .reserva-mini-card-info .reserva-id {
        color: var(--dark-text);
    }
    .reserva-mini-card-info .reserva-dates {
        font-size: 0.85rem;
        color: var(--medium-gray);
    }
    body.dark-mode .reserva-mini-card-info .reserva-dates {
        color: var(--dark-text-secondary);
    }
    .reserva-mini-card-status {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--white);
    }
    .status-confirmado { background-color: var(--available); }
    .status-pendiente { background-color: var(--reserved); }
    /* --- FIN DE NUEVOS ESTILOS --- */
    
</style>

<div class="page-header">
    <h1><i class="fas fa-users"></i> Registro de Huéspedes</h1>
    <a href="{% url 'registrarhuesped' %}" class="btn-new">
        <i class="fas fa-user-plus"></i> Registrar Nuevo
    </a>
</div>

<div class="huesped-grid">
    {% for huesped in huespedes %}
    <div class="huesped-card" 
         data-bs-toggle="modal" 
         data-bs-target="#huespedDetailModal"
         data-huesped-id="{{ huesped.id }}"
         data-nombre="{{ huesped.nombre }}"
         data-apellido="{{ huesped.apellido }}"
         data-tipo-documento="{{ huesped.tipo_documento }}"
         data-identificacion="{{ huesped.identificacion }}"
         data-procedencia="{{ huesped.procedencia }}"
         data-razon="{{ huesped.razon }}"
         data-telefono="{{ huesped.telefono|default:'N/A' }}"
         data-email="{{ huesped.email|default:'N/A' }}"
         data-fecha-nacimiento="{{ huesped.fecha_nacimiento|date:'Y-m-d'|default:'N/A' }}"
         data-nacionalidad="{{ huesped.nacionalidad|default:'N/A' }}"
         data-genero="{{ huesped.get_genero_display|default:'N/A' }}"
         data-preferencias="{{ huesped.preferencias|default:'Ninguna' }}"
         data-fecha-registro="{{ huesped.fecha_registro|date:'d M Y' }}"
         >
        
        <div class="card-header">
            <div class="huesped-avatar">
                {{ huesped.nombre|first|upper }}{{ huesped.apellido|first|upper }}
            </div>
            <div class="huesped-info">
                <div class="huesped-nombre">{{ huesped.nombre }} {{ huesped.apellido }}</div>
                <div class="huesped-id">{{ huesped.tipo_documento }}: {{ huesped.identificacion }}</div>
            </div>
        </div>
        <div class="card-body">
            <div class="info-item">
                <i class="fas fa-phone-alt"></i>
                <span>{{ huesped.telefono|default:'No registrado' }}</span>
            </div>
            <div class="info-item">
                <i class="fas fa-envelope"></i>
                <span>{{ huesped.email|default:'No registrado' }}</span>
            </div>
            <div class="info-item">
                <i class="fas fa-map-marker-alt"></i>
                <span>Procedencia: {{ huesped.procedencia }}</span>
            </div>
        </div>
    </div>
    {% empty %}
        <p style="grid-column: 1 / -1; text-align: center; padding: 50px;">No hay huéspedes registrados. <a href="{% url 'registrarhuesped' %}">Registrar uno nuevo</a>.</p>
    {% endfor %}
</div>

<div class="modal fade" id="huespedDetailModal" tabindex="-1" aria-labelledby="huespedDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="huespedDetailModalLabel">Perfil del Huésped</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBodyContent">
                <p>Cargando detalles...</p>
            </div>
            <div class="modal-footer" style="justify-content: space-between;">
                <div>
                    <button type="button" class="btn btn-danger" id="btnEliminarHuesped">
                        <i class="fas fa-trash-alt"></i> Eliminar
                    </button>
                </div>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="btnEditarHuesped">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background-color: var(--occupied); color: var(--white);">
                <h5 class="modal-title" id="confirmDeleteModalLabel"><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1) grayscale(100%) brightness(200%);"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar permanentemente a este huésped?</p>
                <p><strong id="huespedDeleteInfo"></strong></p>
                <p class="text-muted" style="font-size: 0.85em;"><small>Esta acción no se puede deshacer. Las reservas asociadas (si existen) quedarán sin huésped principal asignado.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarEliminacion">Sí, Eliminar</button>
            </div>
        </div>
    </div>
</div>


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // === JAVASCRIPT ===
    function getCookie(name) { /* ... (Función getCookie) ... */
        let cookieValue = null; if (document.cookie && document.cookie !== '') { const cookies = document.cookie.split(';'); for (let i = 0; i < cookies.length; i++) { const cookie = cookies[i].trim(); if (cookie.substring(0, name.length + 1) === (name + '=')) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; } } } return cookieValue;
     }
    const csrftoken = getCookie('csrftoken');

    // --- Elementos del DOM ---
    const huespedModalElement = document.getElementById('huespedDetailModal');
    const confirmDeleteModalElement = document.getElementById('confirmDeleteModal');
    const btnEditarGlobal = document.getElementById('btnEditarHuesped');
    const btnEliminarGlobal = document.getElementById('btnEliminarHuesped');
    const btnConfirmarEliminacion = document.getElementById('btnConfirmarEliminacion');
    const huespedDeleteInfo = document.getElementById('huespedDeleteInfo');

    let huespedIdParaAccion = null;
    let bootstrapConfirmDeleteModal = null;
    let bootstrapDetailModal = null;

    // --- Inicializar Instancias de Modales ---
    if (typeof bootstrap !== 'undefined') {
        if (confirmDeleteModalElement) {
             try { bootstrapConfirmDeleteModal = new bootstrap.Modal(confirmDeleteModalElement); } catch (e) { console.error("Error inicializando modal de confirmación:", e); }
        }
        if (huespedModalElement) {
             try { bootstrapDetailModal = new bootstrap.Modal(huespedModalElement); } catch (e) { console.error("Error inicializando modal de detalles:", e); }
        }
    } else {
        console.error("¡ERROR CRÍTICO! Bootstrap JS no está cargado.");
    }


    // --- 1. Lógica para Poblar Modal de Detalles ---
    if (huespedModalElement) {
        huespedModalElement.addEventListener('show.bs.modal', function (event) {
            const card = event.relatedTarget;
            if (!card || !card.classList.contains('huesped-card')) return;
            
            const data = card.dataset;
            const modalBody = huespedModalElement.querySelector('#modalBodyContent');
            const huespedId = data.huespedId;

            if (!modalBody || !huespedId) return;

            // Guardar ID en botones
            btnEditarGlobal.dataset.huespedId = huespedId;
            btnEliminarGlobal.dataset.huespedId = huespedId;

            // Generar HTML principal
            modalBody.innerHTML = generateDetailModalHTML(data);
             
            // --- ¡NUEVA LÓGICA! ---
            // Llamar a la función para cargar el historial de reservas
            fetchHuespedReservas(huespedId);
        });
    }

    // --- Función Auxiliar generateDetailModalHTML (MODIFICADA) ---
    function generateDetailModalHTML(data){
        return `
            <div class="detail-section"> <div class="detail-section-title"><i class="fas fa-user-circle"></i> Info Personal</div> <div class="detail-grid"> <div class="detail-item"><span class="detail-label">Nombre</span><span class="detail-value">${data.nombre || 'N/A'}</span></div> <div class="detail-item"><span class="detail-label">Apellido</span><span class="detail-value">${data.apellido || 'N/A'}</span></div> <div class="detail-item"><span class="detail-label">Tipo Doc</span><span class="detail-value">${data.tipoDocumento || 'N/A'}</span></div> <div class="detail-item"><span class="detail-label">Nº Doc</span><span class="detail-value">${data.identificacion || 'N/A'}</span></div> <div class="detail-item"><span class="detail-label">F. Nacim.</span><span class="detail-value">${data.fechaNacimiento || 'N/A'}</span></div> <div class="detail-item"><span class="detail-label">Nacionalidad</span><span class="detail-value">${data.nacionalidad || 'N/A'}</span></div> <div class="detail-item"><span class="detail-label">Género</span><span class="detail-value">${data.genero || 'N/A'}</span></div> </div> </div>
            <div class="detail-section"> <div class="detail-section-title"><i class="fas fa-address-book"></i> Contacto y Viaje</div> <div class="detail-grid"> <div class="detail-item"><span class="detail-label">Teléfono</span><span class="detail-value">${data.telefono || 'N/A'}</span></div> <div class="detail-item"><span class="detail-label">Email</span><span class="detail-value">${data.email || 'N/A'}</span></div> <div class="detail-item"><span class="detail-label">Procedencia</span><span class="detail-value">${data.procedencia || 'N/A'}</span></div> <div class="detail-item"><span class="detail-label">Razón Viaje</span><span class="detail-value">${data.razon || 'N/A'}</span></div> </div> </div>
            <div class="detail-section"> <div class="detail-section-title"><i class="fas fa-clipboard-list"></i> Notas</div> <div class="detail-grid"> <div class="detail-item full-width"><span class="detail-label">Preferencias</span><span class="detail-value">${data.preferencias || 'N/A'}</span></div> <div class="detail-item"><span class="detail-label">Registro</span><span class="detail-value">${data.fechaRegistro || 'N/A'}</span></div> </div> </div>
            
            <div class="detail-section mb-0">
                <div class="detail-section-title"><i class="fas fa-calendar-check"></i> Historial de Reservas</div>
                <div id="huesped-reservas-container">
                    <p>Cargando historial...</p>
                </div>
            </div>
            `;
    }

    // --- ¡NUEVA FUNCIÓN ASÍNCRONA PARA CARGAR RESERVAS! ---
    async function fetchHuespedReservas(huespedId) {
        const container = document.getElementById('huesped-reservas-container');
        if (!container) return;

        const url = `{% url 'huespedreservasajax' 0 %}`.replace('0', huespedId);

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Error de red al cargar reservas.');
            }
            const data = await response.json();

            if (data.status === 'ok') {
                if (data.reservas.length > 0) {
                    let html = '';
                    data.reservas.forEach(res => {
                        html += `
                        <div class="reserva-mini-card">
                            <div class="reserva-mini-card-info">
                                <span class="reserva-id">Reserva #${res.id} (${res.tipo})</span>
                                <span class="reserva-dates">${res.check_in} - ${res.check_out}</span>
                            </div>
                            <span class="reserva-mini-card-status status-${res.estado.toLowerCase()}">
                                ${res.estado}
                            </span>
                        </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p>Este huésped no tiene reservas asociadas.</p>';
                }
            } else {
                container.innerHTML = `<p class="text-danger">Error: ${data.message}</p>`;
            }
        } catch (error) {
            console.error("Error en fetchHuespedReservas:", error);
            container.innerHTML = '<p class="text-danger">No se pudo cargar el historial.</p>';
        }
    }


    // --- 2. Lógica Botón Editar ---
    if (btnEditarGlobal) {
        btnEditarGlobal.addEventListener('click', function() {
            const huespedId = this.dataset.huespedId;
            if (huespedId) { window.location.href = `/huespedes/editar/${huespedId}/`; }
            else { alert("Error: No se pudo identificar al huésped para editar."); }
        });
     }

    // --- 3. Lógica Botón Eliminar (Abre Modal Confirmación) ---
    if (btnEliminarGlobal) {
        btnEliminarGlobal.addEventListener('click', function() {
            huespedIdParaAccion = this.dataset.huespedId;
            if (!huespedIdParaAccion) return;

            const activeCard = document.querySelector(`.huesped-card[data-huesped-id="${huespedIdParaAccion}"]`);
            const nombreHuesped = activeCard ? `${activeCard.dataset.nombre || ''} ${activeCard.dataset.apellido || ''}`.trim() : `ID: ${huespedIdParaAccion}`;
            if (huespedDeleteInfo) huespedDeleteInfo.textContent = nombreHuesped || `ID: ${huespedIdParaAccion}`;
            
            if (bootstrapDetailModal) bootstrapDetailModal.hide();
            if (bootstrapConfirmDeleteModal) bootstrapConfirmDeleteModal.show();
        });
    }

    // --- 4. Lógica Botón Confirmar Eliminación (AJAX POST) ---
    if (btnConfirmarEliminacion) {
        btnConfirmarEliminacion.addEventListener('click', function(event) {
            event.preventDefault();
            if (!huespedIdParaAccion) return;

            const url = `/huespedes/eliminar/${huespedIdParaAccion}/`;
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) { return response.json().then(err => { throw new Error(err.message || 'Error del servidor'); }); }
                return response.json();
            })
            .then(data => {
                if (data.status === 'ok') {
                    const cardToRemove = document.getElementById(`huesped-card-${huespedIdParaAccion}`);
                    if (cardToRemove) {
                        cardToRemove.style.transition = 'opacity 0.5s ease';
                        cardToRemove.style.opacity = '0';
                        setTimeout(() => cardToRemove.remove(), 500);
                    }
                    if(bootstrapConfirmDeleteModal) bootstrapConfirmDeleteModal.hide();
                    alert(data.message); // O un toast/mensaje global
                } else {
                    alert(`Error al eliminar: ${data.message}`);
                }
            })
            .catch(error => {
                alert(`Error al eliminar: ${error.message}`);
            })
            .finally(() => {
                this.disabled = false;
                this.innerHTML = 'Sí, Eliminar';
                huespedIdParaAccion = null;
                if(bootstrapConfirmDeleteModal && bootstrapConfirmDeleteModal._isShown) {
                    bootstrapConfirmDeleteModal.hide();
                }
            });
        });
    }

}); // <-- FIN DE DOMContentLoaded
</script>
{% endblock %}

{% include 'inc/footer.html'%}